---
title: "Final Project EDA"
subtitle: "STAT 301-1 Data Science I"
author: "Holland Blumer"
date: "December 8^th^, 2019"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    highlight: "tango"
---
# Table of Contents
Introduction: Line 12 <br>
Body: Line 42 <br>
Conclusion: Line 390
<br>

# Works Cited
“An Introduction to Stock Market Data Analysis with R (Part 1).” NT Guardian, 28 Mar. 2017, ntguardian.wordpress.com/2017/03/27/introduction-stock-market-data-r-1/.

Grolemund, Garrett, and Hadley Wickham. “R For Data Science.” R For Data Science, r4ds.had.co.nz/index.html.

“NASDAQ Composite (^IXIC) Historical Data.” Yahoo! Finance, Yahoo!, 1 Nov. 2019, finance.yahoo.com/quote/%5EIXIC/history?period1=1483250400&period2=1514700000&interval=1d&filter=history&frequency=1d.

“NCDC Storm Events Database.” Data.gov, Responsible Party DOC/NOAA/NESDIS/NCEI > National Centers for Environmental Information, NESDIS, NOAA, U.S. Department of Commerce (Point of Contact), 27 Feb. 2019, catalog.data.gov/dataset/ncdc-storm-events-database.

“S&amp;P 500 (^GSPC) Historical Data.” Yahoo! Finance, Yahoo!, 7 Dec. 2019, finance.yahoo.com/quote/%5EGSPC/history?p=%5EGSPC.

# Introduction 
The purpose of my final project is to analyze the historical data in the stock market and compare it to a seemingly unrelated data. I'm interested in going into the algorithmic trading industry after I graduate, and this is a perfect chance for me to explore other factors that could potentially impact the algorithms I code in the future. I analyzed the hydro-meteorological range of storms in the US in 2017 and compared the data to the NASDAQ data in 2017 and the S&P500 data in 2017.

<br>


# Data Import
```{r}
nasdaq_2017_by_day <- read.csv('unprocessed data/^IXIC2017.csv')
storm_events_2017_by_month <- read.csv('unprocessed data/StormEvents_locations-ftp_v1.0_d2017_c20190817 copy.csv')

```


#### Load Packages
```{r}
library(tidyverse)
library(tidyr)
library(ggplot2)
library(dplyr)
library(readr)
library(lubridate)
library(grid)
library(gridExtra)

```
<br>

#### Body
First, I want to get a glimpse of the data I imported. 
```{r}
glimpse(nasdaq_2017_by_day)
glimpse(storm_events_2017_by_month)
```
<br>
In the NASDAQ data from 2017, I want to check if close and adj_close have the same values
```{r}
nasdaq_2017_by_day %>%
  filter(Close != Adj.Close)
```
<br>
It looks like they do have the same values. The open and close prices are not all the same, however. 
<br>
```{r}
nasdaq_2017_by_day %>%
  filter(Close != Open)
```
<br>
Next, I want to make a tibble with the variables I might compare.
<br>
```{r}
nasdaq_2017_by_day_tibble <- tibble(
  open = nasdaq_2017_by_day$Open,
  high = nasdaq_2017_by_day$High,
  low = nasdaq_2017_by_day$Low,
  close = nasdaq_2017_by_day$Close,
  date_2017_nasdaq = nasdaq_2017_by_day$Date)
```
<br>
It's difficult for me to visualize the trends in the tibble, so I will make a graph. 
<br>
```{r}
nasdaq_2017_by_day_tibble %>%
  ggplot(aes(date_2017_nasdaq, close, group = 1)) +
  geom_line() +
  xlab("Date in 2017") +
  ylab("Closing Price") +
  ggtitle("NASDAQ Closing Prices in 2017") +
  theme(axis.text.x = element_text(angle = 90, hjust = 0, size = 4))
```
<br>
I want to plot the open and close prices on the same graph.
<br>
```{r}
nasdaq_2017_plot <- nasdaq_2017_by_day_tibble %>%
  ggplot(aes(date_2017_nasdaq, group = 1)) +
  geom_line(aes(y=close, group = 1), color="red") +  
  geom_line(aes(y=open, group = 1), color="green") + 
  xlab("Date in 2017") +
  ylab("Price") +
  ggtitle("NASDAQ Prices in 2017") +
  theme(axis.text.x = element_text(angle = 90, hjust = 0, size = 4), legend.title = element_blank()) 
  
nasdaq_2017_plot
```
<br>
The trends in the open and close prices look pretty similar. The open prices are in green and the close prices are in red. I will analyze this price discrepancy later. I want to pull the variables for the storm data. 
<br>
```{r}
storm_events_2017_by_month_tibble <- tibble(
  date_unformatted = storm_events_2017_by_month$YEARMONTH,
  range = storm_events_2017_by_month$RANGE)
```
<br>

Next, I want to plot the data. I have a feeling this will not be formatted. 
<br>
```{r}
storm_events_2017_by_month_plot <- storm_events_2017_by_month_tibble %>%
  ggplot(aes(x = date_unformatted)) +
  geom_point(aes(y=range), color="green") +
  xlab("Unformatted Dates") +
  ylab("Range") +
  ggtitle("Storm Events in 2017 (Unformatted)")
storm_events_2017_by_month_plot
```
<br>
The data above isn't properly formatted. In hindsight, I could've made a boxplot. I decided to take the mean of the range values each month. 
<br>
```{r}
filter_jan_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201701)
  mean_jan_range <- mean(filter_jan_storms_2017$range)

filter_feb_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201702)
  mean_feb_range <- mean(filter_feb_storms_2017$range)

filter_mar_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201703)
  mean_mar_range <- mean(filter_mar_storms_2017$range)
  
filter_apr_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201704)
  mean_apr_range <- mean(filter_apr_storms_2017$range)
  
filter_may_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201705)
  mean_may_range <- mean(filter_may_storms_2017$range)
  
filter_jun_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201706)
  mean_jun_range <- mean(filter_jun_storms_2017$range)

filter_jul_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201707)
  mean_jul_range <- mean(filter_jul_storms_2017$range)
  
filter_aug_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201708)
  mean_aug_range <- mean(filter_aug_storms_2017$range)
  
filter_sep_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201709)
  mean_sep_range <- mean(filter_sep_storms_2017$range)
  
filter_oct_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201710)
  mean_oct_range <- mean(filter_oct_storms_2017$range)

filter_nov_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201711)
  mean_nov_range <- mean(filter_nov_storms_2017$range)
  
filter_dec_storms_2017 <- filter(storm_events_2017_by_month_tibble, date_unformatted == 201712)
  mean_dec_range <- mean(filter_dec_storms_2017$range)
```

<br>
I tried to parse the dates in the file, but was struggling to do so. Instead, I renamed all of the dates to put in a new tibble with the mean range values. 
<br>
```{r}
month_year_weather_2017 <- c("01/2017","02/2017","03/2017","04/2017","05/2017","06/2017","07/2017","08/2017","09/2017","10/2017","11/2017","12/2017")
mean_range_values <- c(mean_jan_range, mean_feb_range, mean_mar_range, mean_apr_range, mean_may_range, mean_jun_range, mean_jul_range, mean_aug_range, mean_sep_range, mean_oct_range, mean_nov_range, mean_dec_range)
tidy_range_tibble <- tibble(month_year_weather_2017, mean_range_values)
```
<br>
Let's plot the new tibble. 
<br>
```{r}
tidy_range_plot <- tidy_range_tibble %>%
  ggplot(aes(month_year_weather_2017, mean_range_values, group = 1)) +
  geom_line() +
  geom_smooth(method = "lm") +
  xlab("Month in 2017") +
  ylab("Range") +
  ggtitle("Average Range of Storms Each Month in 2017") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) 
tidy_range_plot
```
<br>
We can compare the untidy vs tidy plots side-by-side using grid.arrange. 
<br>
```{r}
grid.arrange(storm_events_2017_by_month_plot, tidy_range_plot, nrow=2)
```
<br>
When I compare the tidy storm data plot with the tidy NASDAQ data plot, I realize I need more data from NASDAQ. 
<br>
```{r}
grid.arrange(nasdaq_2017_plot, tidy_range_plot, nrow=2)
```
<br>
I realized that I should have plotted the data for the whole year. Instead of grouping the dates by month and finding the mean open and close prices per month, I looked up the monthly data from Yahoo Finance. 
<br>
```{r}
nasdaq_2017_by_month <- read.csv('unprocessed data/^IXIC_monthly_2017.csv')
```
<br>
For this new data, I'm going to make a new tibble and use ggplot to make the visual. 
<br>
```{r}
nasdaq_2017_by_month_tibble <- tibble(
  date_nasdaq_month = nasdaq_2017_by_month$Date,
  close_nasdaq_month = nasdaq_2017_by_month$Close,
  open_nasdaq_month = nasdaq_2017_by_month$Open)

nasdaq_2017_by_month_plot <- nasdaq_2017_by_month_tibble %>%
  ggplot(aes(date_nasdaq_month, group = 1)) +
  geom_line(aes(y=close_nasdaq_month, group = 1), color = "blue") +
  geom_line(aes(y=open_nasdaq_month, group = 1), color = "green") +
  xlab("Month in 2017") +
  ylab("Price") +
  ggtitle("Price of Nasdaq per Month in 2017") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) 
nasdaq_2017_by_month_plot 
```
<br>
I want to add the weather data tibble to the monthly Nasdaq prices tibble and store it in the processed file. 
<br>
```{r}
weather_nasdaq_2017_combined <- merge(nasdaq_2017_by_month_tibble, tidy_range_tibble, by = 0, all = TRUE, sort = FALSE)
write.csv(weather_nasdaq_2017_combined, "processed data/weather_nasdaq_2017_combined.csv")
```
<br>
Next I want to plot the open and close prices with the range, to spot any trend I multiplied the mean values by 2500
<br>
```{r}
weather_nasdaq_2017_combined_plot <- weather_nasdaq_2017_combined %>%
  ggplot(aes(date_nasdaq_month, group = 1)) +
  geom_line(aes(y=close_nasdaq_month, group = 1), color="blue") +
  geom_line(aes(y=open_nasdaq_month, group = 1), color="pink") +
  geom_line(aes(y=mean_range_values*2500, group = 1), color="green") +
  xlab("Month in 2017") +
  ylab("Trend Values") +
  ggtitle("Comparing Nasdaq Open and Close prices with Storm Range") +
  theme(axis.text.x = element_text(angle = 90, hjust = 0, size = 8)) 
weather_nasdaq_2017_combined_plot
```
<br>
The green is the mean range values, the pink represents the open NASDAQ prices, and the blue represents the close NASDAQ prices. Perhaps it's more ethical to plot them side by side instead of on the same grid.
<br>
```{r}
grid.arrange(tidy_range_plot, nasdaq_2017_by_month_plot, nrow = 2)
```


<br>
It's still hard to see if the price increased or decreased or if the storm range increased or decreased each month, I can check this using an embedded loop. 
<br>
```{r}
df_nasdaq_close_monthly = data.frame(nasdaq_2017_by_month_tibble$close_nasdaq_month)

i = 1
while (i<12){
for (value in df_nasdaq_close_monthly) {
  if(value[i] <= value[i+1]){ 
    print("Increase")
    i = i + 1
  }else{
    print("Decrease")
    i = i + 1
  }
}
}

```
<br>
The data is mainly increasing, now I will analyze the open price data per month. Let's check the flucuation in the open prices.
<br>
```{r}
df_nasdaq_open_monthly = data.frame(nasdaq_2017_by_month_tibble$open_nasdaq_month)

j = 1
while (j<12){
  for (value in df_nasdaq_open_monthly) {
    if(value[j] <= value[j+1]){ 
      print("Increase")
      j = j + 1
    }else{
      print("Decrease")
      j = j + 1
    }
  }
}
```
<br>
There is little fluctuation here too. This makes sense because the open and close price data are similar.
<br>
```{r}
range_weather_monthly = data.frame(weather_nasdaq_2017_combined$mean_range_values)
j = 1
while (j<12){
  for (value in range_weather_monthly) {
    if(value[j] <= value[j+1]){ 
      print("Increase")
      j = j + 1
    }else{
      print("Decrease")
      j = j + 1
    }
  }
}
```

<br>
The range fluctuates more each month. It's hard to spot a trend. Perhaps the SP500 matches more. I need to import this data to see. 
<br>

```{r}
sp500_by_month_2017 <- read.csv('unprocessed data/SP500_2017.csv') 
```
<br>
I'm assuming this data looks similar to the NASDAQ data, because I downloaded both of them from Yahoo Finance, but I want to make sure. 
<br>
```{r}
glimpse(nasdaq_2017_by_day)
```

<br>
I am also curious to see if close and adj.close are the same here.
<br>

```{r}
sp500_by_month_2017 %>%
  filter(Close != Adj.Close)
```

<br>
They are the same because there are 0 rows. 
<br>

```{r}
sp500_by_month_2017_tibble <- tibble(
  date_sp500_month = sp500_by_month_2017$Date,
  open_sp500_month = sp500_by_month_2017$Open,
  close_sp500_month = sp500_by_month_2017$Close)
sp500_by_month_2017_tibble
```
<br>
```{r}
range_NASDAQ_SP500_2017 <- merge(weather_nasdaq_2017_combined, sp500_by_month_2017_tibble$close_sp500_month, by = 0, all = TRUE, sort = FALSE)
write.csv(range_NASDAQ_SP500_2017, "processed data/range_NASDAQ_SP500_2017.csv")
```


<br>
I want to compare the means of the open and close prices, because I think they are too similar to include both.
<br>
```{r}
(1 - (mean(sp500_by_month_2017_tibble$open_sp500_month)/mean(sp500_by_month_2017_tibble$close_sp500_month)))*100
```
<br>
As expected, the percent difference is so small (less than 2%). Thus, I will compare the S&P close prices only this time. 
<br>
```{r}
sp500_2017_by_month_plot <- sp500_by_month_2017_tibble %>%
  ggplot(aes(date_sp500_month, close_sp500_month, group = 1)) +
  geom_line(color="blue") +
  xlab("Month in 2017") +
  ylab("Price") +
  ggtitle("Closing S&P 500 Prices per Month in 2017") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) 
sp500_2017_by_month_plot
```
<br>
I want to compare the weather data, NASDAQ data, and S&P 500 data side-by-side. 
<br>
```{r}
grid.arrange(tidy_range_plot, nasdaq_2017_by_month_plot, sp500_2017_by_month_plot, nrow=3)
```
<br>
Let's make another while loop to analyze the fluctuation in the Closing S&P 500 Prices.
<br>
```{r}
df_sp500_close_monthly = data.frame(sp500_by_month_2017_tibble$close_sp500_month)
h = 1
while (h<12){
  for (value in df_sp500_close_monthly) {
    if(value[h] <= value[h+1]){ 
      print("Increase")
      h = h + 1
    }else{
      print("Decrease")
      h = h + 1
    }
  }
}
```
<br>
There seems to be little fluctuation in the S&P 500 data. Perhaps the weather affects the S&P Market more. It might be beneficial to associate a symbol, such as an up arrow with increase and a down arrow with decrease. Then we could copare these symbols side by side in another tibble. 
<br>
For my own benefit, I learned that you can scrape data from the web using the quantmode function. It seems pretty easy to use according to this article https://ntguardian.wordpress.com/2017/03/27/introduction-stock-market-data-r-1/.
<br>


# Conclusion
According to this analysis, there doesn't seem to be a strong correlation between the market data and the storm data from the same year, but I'm not ready to reject that there is one. I made a significant assumption that the monthly data I got from Yahoo finance corresponds to the average of opening and closing prices each month. It could be that the data correspond to the mean prices the month before. On another note, I plan to explore more datasets related to storm data when developing an algorithm for investing. Overall, this project provided me the opportunity to feature all of the skills I have learned this quarter and draw connections between all of the chapters we have read. I feel much more prepared for the next quarter after doing this project. 




